# 批量导入功能安装说明

## 📦 安装步骤

### 1. 执行SQL脚本创建存储过程和触发器

在MySQL中执行以下命令：

```bash
mysql -u root -p project < sql/database_procedures_and_triggers.sql
```

或者在MySQL客户端中：

```sql
USE project;
SOURCE sql/database_procedures_and_triggers.sql;
```

### 2. 验证安装

执行以下SQL命令验证：

```sql
-- 检查存储过程
SHOW PROCEDURE STATUS WHERE Db = 'project';

-- 应该看到：
-- sp_import_artifact_metadata
-- sp_log_import_error

-- 检查触发器
SHOW TRIGGERS FROM project;

-- 应该看到：
-- image_replace_log (BEFORE UPDATE on IMAGE_VERSIONS)
```

### 3. 测试存储过程

```sql
-- 测试调用存储过程（示例）
CALL sp_import_artifact_metadata(
    1,              -- Source_ID
    'TEST001',      -- Original_ID
    '测试文物',      -- Title_CN
    NULL,           -- Title_EN
    NULL,           -- Description_CN
    NULL,           -- Classification
    NULL,           -- Material
    NULL,           -- Date_CN
    NULL,           -- Date_EN
    NULL,           -- Start_Year
    NULL,           -- End_Year
    NULL,           -- Geography
    NULL,           -- Culture
    NULL,           -- Artist
    NULL,           -- Credit_Line
    NULL,           -- Page_Link
    NULL,           -- Size_Type
    NULL,           -- Size_Value
    NULL,           -- Size_Unit
    NULL,           -- Image_Link
    NULL,           -- Local_Path
    'Original',     -- Version_Type
    'test_user',    -- User_ID
    'skip',         -- Import_Mode
    @p_artifact_id,
    @p_result_status,
    @p_result_message
);

-- 查看结果
SELECT @p_artifact_id, @p_result_status, @p_result_message;
```

---

## ✅ 功能验证

### 验证批量导入功能

1. 登录后台管理：`http://localhost:5000/admin/login`
2. 访问导入页面：`http://localhost:5000/admin/import`
3. 上传测试文件并导入
4. 检查日志：`http://localhost:5000/admin/logs`

### 验证图像替换触发器

1. 访问图像管理：`http://localhost:5000/admin/images`
2. 选择一个图像进行替换
3. 检查日志中是否有 IMAGE_REPLACE 记录
4. 验证日志包含：
   - 原文件路径
   - 新文件路径
   - 替换时间
   - 操作人

---

## 🔧 故障排查

### 如果存储过程创建失败

检查MySQL版本（需要5.5+）：
```sql
SELECT VERSION();
```

### 如果触发器未触发

检查触发器状态：
```sql
SHOW TRIGGERS FROM project WHERE `Trigger` = 'image_replace_log';
```

检查是否有权限：
```sql
SHOW GRANTS FOR CURRENT_USER();
```

---

## 📝 注意事项

1. **备份数据库**：执行脚本前建议备份数据库
2. **权限要求**：需要CREATE PROCEDURE和CREATE TRIGGER权限
3. **MySQL版本**：建议使用MySQL 5.5或更高版本
4. **字符集**：确保数据库和表使用UTF-8字符集

---

## 📚 相关文档

- `批量导入功能说明.md` - 详细功能说明
- `sql/database_procedures_and_triggers.sql` - SQL脚本文件
- `ADMIN_FEATURES_CHECKLIST.md` - 后台功能清单

