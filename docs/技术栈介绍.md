# 遗珍图库系统 - 技术栈详细介绍

## 一、系统架构概览

本系统采用经典的 **MVC（Model-View-Controller）架构模式**：
- **Model（模型层）**：MySQL数据库存储文物元数据
- **View（视图层）**：Jinja2模板引擎渲染HTML页面
- **Controller（控制层）**：Flask路由处理业务逻辑

---

## 二、后端技术栈

### 2.1 核心框架：Flask

**Flask** 是一个轻量级的Python Web框架，采用微内核设计。

#### 为什么选择Flask？
- **轻量级**：核心功能精简，按需扩展
- **灵活性高**：不强制项目结构，适合快速开发
- **生态丰富**：丰富的扩展库支持
- **学习曲线平缓**：适合中小型项目

#### 在本项目中的应用：
```python
# app.py 中的核心应用实例
app = Flask(__name__)
app.secret_key = os.getenv('SECRET_KEY', 'your-secret-key-change-in-production-2024')
```

**主要功能模块**：
1. **路由系统**：使用装饰器 `@app.route()` 定义URL路由
2. **模板渲染**：`render_template()` 渲染Jinja2模板
3. **会话管理**：`session` 对象管理用户登录状态
4. **请求处理**：`request` 对象获取表单数据、查询参数
5. **JSON API**：`jsonify()` 返回JSON格式数据

### 2.2 编程语言：Python 3.x

**Python** 是本项目的核心编程语言。

#### 优势：
- **语法简洁**：代码可读性强，开发效率高
- **丰富的标准库**：内置模块支持多种功能
- **强大的数据处理能力**：适合处理文物元数据

#### 在本项目中使用的主要Python特性：
- **装饰器**：用于路由定义和权限验证
- **字典操作**：处理数据库查询结果
- **异常处理**：`try-except` 处理数据库连接错误
- **正则表达式**：`re` 模块解析日期字符串
- **环境变量**：`os.getenv()` 读取配置信息

### 2.3 数据库：MySQL 8.0

**MySQL** 是一个开源的关系型数据库管理系统。

#### 数据库设计特点：
- **规范化设计**：采用第三范式，减少数据冗余
- **多表关联**：通过外键建立表间关系
- **索引优化**：主键、外键自动创建索引

#### 核心数据表结构：
1. **ARTIFACTS（文物主表）**
   - 存储文物的基本信息（标题、描述、分类、材质、年代等）
   - 主键：`Artifact_PK`（自增整数）

2. **PROPERTIES（属性表）**
   - 存储文物的扩展属性（地理、文化、艺术家、来源链接等）
   - 外键关联：`Artifact_PK`

3. **IMAGE_VERSIONS（图片版本表）**
   - 存储文物的图片信息（本地路径、文件大小、处理时间等）
   - 支持一个文物多张图片

4. **DIMENSIONS（尺寸表）**
   - 存储文物的尺寸信息（高度、宽度、深度等）
   - 支持一个文物多个尺寸记录

5. **SOURCES（来源表）**
   - 存储博物馆/机构信息

6. **LOGS（日志表）**
   - 记录所有数据操作的审计日志

7. **Users、Albums、Collections（用户系统表）**
   - 支持用户注册、登录、图集管理功能

#### 数据库连接：
```python
# 使用 mysql-connector-python 连接MySQL
import mysql.connector
conn = mysql.connector.connect(
    host='localhost',
    user='root',
    password='leeanna',
    database='project'
)
```

### 2.4 数据库连接器：mysql-connector-python 8.2.0

**mysql-connector-python** 是MySQL官方提供的Python数据库连接器。

#### 特点：
- **纯Python实现**：不依赖MySQL客户端库
- **支持Python 3.x**：完全兼容现代Python版本
- **字典游标**：`cursor(dictionary=True)` 返回字典格式结果

#### 使用示例：
```python
cursor = conn.cursor(dictionary=True)  # 返回字典格式
cursor.execute("SELECT * FROM ARTIFACTS WHERE Artifact_PK = %s", (id,))
artifact = cursor.fetchone()  # 返回字典：{'Artifact_PK': 1, 'Title_CN': '...'}
```

### 2.5 安全模块：Werkzeug 3.0.1

**Werkzeug** 是Flask的底层WSGI工具库，本项目主要使用其密码哈希功能。

#### 密码安全：
```python
from werkzeug.security import generate_password_hash, check_password_hash

# 注册时：生成密码哈希
password_hash = generate_password_hash(password)

# 登录时：验证密码
if check_password_hash(user['password_hash'], password):
    # 登录成功
```

**安全特性**：
- **PBKDF2算法**：使用密钥派生函数加密密码
- **盐值随机化**：每次加密使用不同的盐值
- **防止彩虹表攻击**：即使相同密码，哈希值也不同

### 2.6 数据处理：Pandas

**Pandas** 用于处理Excel/CSV文件导入功能。

#### 使用场景：
- **管理员批量导入**：读取Excel/CSV文件
- **数据验证**：检查必需列是否存在
- **数据转换**：将DataFrame转换为数据库记录

```python
import pandas as pd
df = pd.read_excel(file)  # 读取Excel文件
df = pd.read_csv(file, encoding='utf-8')  # 读取CSV文件
```

### 2.7 模板引擎：Jinja2

**Jinja2** 是Flask默认的模板引擎，用于动态生成HTML。

#### 核心语法：
- **变量输出**：`{{ variable }}`
- **控制结构**：`{% if %}`, `{% for %}`
- **模板继承**：`{% extends %}`, `{% block %}`
- **URL生成**：`{{ url_for('route_name') }}`

#### 示例：
```jinja2
{% for artifact in artifacts %}
    <div class="card">
        <img src="{{ url_for('static', filename=artifact.local_path) }}">
        <h3>{{ artifact.title }}</h3>
    </div>
{% endfor %}
```

---

## 三、前端技术栈

### 3.1 HTML5

**HTML5** 提供了语义化标签和现代Web特性。

#### 使用的HTML5特性：
- **语义化标签**：`<header>`, `<nav>`, `<section>`, `<footer>`
- **表单增强**：`<input type="text">` 支持占位符
- **多媒体支持**：`<img>` 标签显示文物图片

### 3.2 CSS3

**CSS3** 提供了强大的样式和动画能力。

#### 3.2.1 CSS变量（Custom Properties）

**CSS变量** 实现了主题色的统一管理：

```css
:root {
    --color-primary: #9E97B0;   /* 紫藤灰 */
    --color-bg: #F7F6F9;        /* 雾白 */
    --color-accent: #E0C082;    /* 枯金 */
    --color-text: #4A4063;      /* 黛紫 */
}

.card {
    background-color: var(--color-white);
    color: var(--color-text);
}
```

**优势**：
- **统一管理**：修改一处，全局生效
- **主题切换**：便于实现暗色模式等功能
- **维护性强**：代码更清晰，易于理解

#### 3.2.2 Flexbox布局

**Flexbox** 用于实现灵活的布局：

```css
.navbar {
    display: flex;
    justify-content: space-between;  /* 两端对齐 */
    align-items: center;             /* 垂直居中 */
}

.explore-list {
    display: flex;
    flex-direction: column;          /* 垂直排列 */
    gap: 30px;                       /* 间距 */
}
```

**应用场景**：
- **导航栏**：Logo、搜索框、用户菜单的水平排列
- **卡片布局**：文物卡片的响应式排列
- **详情页**：图片区域和信息区域的并排显示

#### 3.2.3 Grid布局

**Grid布局** 用于实现复杂的网格系统：

```css
.catalog-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 30px;
}
```

**特点**：
- **响应式**：`auto-fill` 自动适应屏幕宽度
- **最小宽度控制**：`minmax(250px, 1fr)` 确保卡片最小250px
- **自动换行**：超出容器宽度自动换行

#### 3.2.4 CSS过渡（Transitions）

**CSS过渡** 实现平滑的状态变化：

```css
.card {
    transition: transform 0.2s;  /* 过渡属性：transform，时长：0.2秒 */
}

.card:hover {
    transform: translateY(-5px);  /* 悬停时上移5px */
}
```

**常用过渡属性**：
- `transform`：位移、缩放、旋转
- `opacity`：透明度变化
- `box-shadow`：阴影变化
- `background-color`：背景色变化

#### 3.2.5 CSS变换（Transforms）

**CSS变换** 实现元素的几何变换：

```css
.curtain.left {
    transform: translateY(-50%) scale(0.7);  /* 垂直居中 + 缩放70% */
}

.hero-section.active .curtain.left {
    transform: translateY(-50%) scale(1.1);  /* 激活时放大到110% */
}
```

**变换类型**：
- `translateX/Y()`：位移
- `scale()`：缩放
- `rotate()`：旋转
- `skew()`：倾斜

### 3.3 JavaScript（原生ES5/ES6）

本项目使用**原生JavaScript**，未使用任何前端框架。

#### 3.3.1 DOM操作

```javascript
// 获取元素
const hero = document.querySelector('.hero-section');
const img = document.getElementById('mainImage');

// 添加/移除类
hero.classList.toggle('active');
hero.classList.add('active');
hero.classList.remove('active');
```

#### 3.3.2 事件监听

```javascript
// 点击事件
hero.addEventListener('click', toggleHero);

// 滚动事件
window.addEventListener('scroll', () => {
    if (window.scrollY > 100) {
        document.body.classList.add('scrolled');
    }
});

// 键盘事件
searchInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        searchForm.submit();
    }
});
```

#### 3.3.3 图片缩放功能

```javascript
let scale = 1;

function zoomIn() {
    scale += 0.2;
    img.style.transform = `scale(${scale})`;
}

function zoomOut() {
    if (scale > 0.4) scale -= 0.2;
    img.style.transform = `scale(${scale})`;
}
```

#### 3.3.4 平滑滚动

```javascript
function scrollToExplore(e) {
    e.stopPropagation();  // 阻止事件冒泡
    document.getElementById('explore').scrollIntoView({
        behavior: 'smooth'  // 平滑滚动
    });
}
```

---

## 四、前端动画实现详解

### 4.1 动画技术分类

本系统的动画主要分为三类：
1. **CSS过渡动画（Transitions）**
2. **CSS关键帧动画（Keyframes）**
3. **JavaScript控制的类切换动画**

### 4.2 首页"幕布拉开"动画

#### 4.2.1 动画效果描述

首页采用"幕布拉开"的交互式动画：
- **初始状态**：左右两侧各有一张文物图片（缩小70%，位于屏幕外）
- **触发方式**：用户点击首屏区域
- **动画效果**：
  1. 左右图片向中间移动并放大
  2. 标题文字淡出消失
  3. 背景名言文字淡入显示
  4. 底部引导箭头出现并上下跳动

#### 4.2.2 实现原理

**步骤1：HTML结构**
```html
<section class="hero-section" onclick="toggleHero()">
    <div class="cover-title">
        <div class="main-title">遗珍图库</div>
    </div>
    <div class="curtain left"></div>
    <div class="curtain right"></div>
    <div class="quote-layer">...</div>
</section>
```

**步骤2：CSS初始状态**
```css
.curtain.left {
    left: -10%;                    /* 位于屏幕左侧外 */
    transform: translateY(-50%) scale(0.7);  /* 垂直居中，缩小70% */
    opacity: 0.9;
    transition: all 1.2s cubic-bezier(0.4, 0, 0.2, 1);  /* 1.2秒过渡 */
}

.cover-title {
    opacity: 1;                    /* 初始显示 */
    transition: opacity 0.8s ease, transform 0.8s ease;
}

.quote-layer {
    opacity: 0;                    /* 初始隐藏 */
    transition: opacity 1.2s ease;
}
```

**步骤3：激活状态CSS**
```css
.hero-section.active .curtain.left {
    left: 25%;                    /* 移动到屏幕25%位置 */
    transform: translateY(-50%) scale(1.1);  /* 放大到110% */
    opacity: 1;
}

.hero-section.active .cover-title {
    opacity: 0;                    /* 淡出 */
    transform: scale(1.1);
    filter: blur(4px);
}

.hero-section.active .quote-layer {
    opacity: 1;                    /* 淡入 */
}
```

**步骤4：JavaScript控制**
```javascript
function toggleHero() {
    const hero = document.querySelector('.hero-section');
    hero.classList.toggle('active');  // 切换active类
}
```

**动画时序**：
- **过渡时长**：1.2秒（`--transition-speed: 1.2s`）
- **缓动函数**：`cubic-bezier(0.4, 0, 0.2, 1)`（先慢后快再慢）
- **触发方式**：点击首屏区域，通过`toggleHero()`函数切换`active`类

### 4.3 卡片悬停动画

#### 4.3.1 效果描述

当鼠标悬停在文物卡片上时：
- 卡片上移5px
- 阴影加深
- 缩略图放大10%

#### 4.3.2 实现代码

```css
.card {
    transition: transform 0.2s;  /* 0.2秒过渡 */
}

.card:hover {
    transform: translateY(-5px);  /* 上移5px */
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);  /* 阴影加深 */
}

.thumbnail-item:hover {
    transform: scale(1.1);  /* 放大10% */
    border-color: var(--color-primary);  /* 边框变色 */
}
```

### 4.4 引导箭头跳动动画

#### 4.4.1 效果描述

底部引导箭头持续上下跳动，提示用户向下滚动。

#### 4.4.2 实现代码

**CSS关键帧定义**：
```css
@keyframes bounce {
    0%, 20%, 50%, 80%, 100% {
        transform: translateX(-50%) translateY(0);  /* 原始位置 */
    }
    40% {
        transform: translateX(-50%) translateY(-10px);  /* 上移10px */
    }
    60% {
        transform: translateX(-50%) translateY(-5px);  /* 上移5px */
    }
}
```

**应用动画**：
```css
.scroll-hint {
    animation: bounce 2s infinite;  /* 2秒循环，无限重复 */
    opacity: 0;
    transition: opacity 1s ease 1s;  /* 延迟1秒后显示 */
}

.hero-section.active .scroll-hint {
    opacity: 1;  /* 激活后显示 */
}
```

**动画特点**：
- **无限循环**：`infinite` 关键字
- **平滑过渡**：关键帧之间的自动插值
- **延迟显示**：`transition: opacity 1s ease 1s`（延迟1秒）

### 4.5 导航栏滑入动画

#### 4.5.1 效果描述

页面滚动超过100px时，导航栏从顶部滑入。

#### 4.5.2 实现代码

**CSS初始状态**：
```css
.navbar {
    position: fixed;
    top: -80px;  /* 初始在屏幕外 */
    transition: top 0.5s ease 0.5s;  /* 延迟0.5秒出现 */
}
```

**激活状态**：
```css
body.scrolled .navbar {
    top: 0;  /* 滑入到顶部 */
}
```

**JavaScript监听滚动**：
```javascript
window.addEventListener('scroll', () => {
    if (window.scrollY > 100) {
        document.body.classList.add('scrolled');
    } else {
        document.body.classList.remove('scrolled');
    }
});
```

### 4.6 探索区域背景模糊动画

#### 4.6.1 效果描述

探索区域的卡片使用多张文物图片作为模糊背景，悬停时背景图片放大并变清晰。

#### 4.6.2 实现代码

**HTML结构**：
```html
<div class="explore-item">
    <div class="explore-bg">
        <div class="explore-bg-item" style="background-image: url('...');"></div>
        <div class="explore-bg-item" style="background-image: url('...');"></div>
        <!-- 共6张图片，3x2网格 -->
    </div>
    <div class="explore-overlay"></div>
    <div class="explore-text">随机浏览</div>
</div>
```

**CSS样式**：
```css
.explore-bg-item {
    flex: 1 1 33.333%;  /* 每个占33.333%宽度 */
    height: 50%;        /* 每个占50%高度 */
    background-size: cover;
    filter: blur(8px);   /* 模糊8px */
    transform: scale(1.2);  /* 放大120% */
    opacity: 0.6;
    transition: transform 0.5s ease, opacity 0.5s ease;
}

.explore-item:hover .explore-bg-item {
    transform: scale(1.3);  /* 悬停时放大到130% */
    opacity: 0.8;            /* 透明度增加 */
}
```

**动画特点**：
- **模糊效果**：`filter: blur(8px)` 创造景深效果
- **缩放动画**：`scale(1.2)` → `scale(1.3)` 创造"拉近"效果
- **透明度变化**：`opacity: 0.6` → `0.8` 增加视觉层次

### 4.7 图片查看器缩放动画

#### 4.7.1 效果描述

详情页的图片支持放大、缩小、重置功能，使用CSS `transform: scale()` 实现。

#### 4.7.2 实现代码

**JavaScript控制**：
```javascript
let scale = 1;

function zoomIn() {
    scale += 0.2;  // 每次放大20%
    applyTransform();
}

function zoomOut() {
    if (scale > 0.4) scale -= 0.2;  // 最小缩放到40%
    applyTransform();
}

function applyTransform() {
    img.style.transform = `scale(${scale})`;
}
```

**CSS过渡**：
```css
.artifact-img {
    transition: transform 0.3s ease;  /* 平滑缩放 */
    cursor: grab;  /* 抓取光标 */
}
```

---

## 五、技术架构亮点

### 5.1 SQL查询构建器（query_builder.py）

**设计理念**：将SQL查询逻辑与业务代码分离，实现配置化管理。

**优势**：
- **可维护性强**：修改查询只需修改配置文件
- **代码复用**：相同查询逻辑可多处使用
- **易于测试**：查询逻辑独立，便于单元测试

**示例**：
```python
def build_search_query(search_term):
    query = f"""
        SELECT DISTINCT 
            a.Artifact_PK AS artifact_id,
            a.Title_CN AS title,
            ...
        FROM {TABLES['artifacts']} a
        LEFT JOIN {TABLES['image_versions']} iv ON ...
        WHERE a.Title_CN LIKE %s OR ...
    """
    return query.strip()
```

### 5.2 数据库配置化（db_config.py）

**设计理念**：统一管理数据库表名、字段名映射，便于数据库迁移。

**优势**：
- **统一管理**：所有表名、字段名集中配置
- **易于迁移**：修改数据库结构只需修改配置文件
- **减少错误**：避免硬编码表名导致的拼写错误

### 5.3 图片路径规范化（normalize_image_path）

**功能**：统一处理不同格式的图片路径，确保路径正确。

**处理逻辑**：
1. 将Windows路径的反斜杠转换为正斜杠
2. 移除开头的斜杠
3. 提取`static/`后面的相对路径
4. 确保路径以`images/`开头

---

## 六、开发工具与环境

### 6.1 版本控制
- **Git**：代码版本管理

### 6.2 开发环境
- **Python 3.x**：推荐Python 3.8+
- **MySQL 8.0**：数据库服务器
- **虚拟环境**：`venv` 隔离项目依赖

### 6.3 依赖管理
- **requirements.txt**：记录所有Python依赖包及版本

---

## 七、性能优化

### 7.1 数据库优化
- **索引**：主键、外键自动创建索引
- **连接池**：每次请求创建新连接（可优化为连接池）
- **查询优化**：使用`ANY_VALUE()`避免GROUP BY错误

### 7.2 前端优化
- **CSS变量**：减少重复代码
- **过渡动画**：使用GPU加速的`transform`属性
- **图片懒加载**：可进一步优化为延迟加载

### 7.3 缓存策略
- **Session存储**：用户登录状态存储在服务器Session
- **静态资源**：CSS、JS、图片由Flask静态文件服务

---

## 八、安全特性

### 8.1 密码安全
- **哈希加密**：使用Werkzeug的PBKDF2算法
- **盐值随机化**：每次加密使用不同盐值

### 8.2 SQL注入防护
- **参数化查询**：使用`%s`占位符，避免SQL注入

```python
cursor.execute("SELECT * FROM ARTIFACTS WHERE Artifact_PK = %s", (id,))
```

### 8.3 文件上传安全
- **文件类型验证**：`allowed_file()` 函数检查文件扩展名
- **文件名安全化**：`secure_filename()` 防止路径遍历攻击

---

## 九、总结

### 9.1 技术选型理由

1. **Flask vs Django**
   - 选择Flask：项目规模中等，需要灵活性
   - Django更适合大型项目，但学习曲线陡

2. **原生JavaScript vs 框架**
   - 选择原生JS：项目交互简单，无需复杂状态管理
   - React/Vue适合SPA应用，但增加复杂度

3. **MySQL vs PostgreSQL**
   - 选择MySQL：团队熟悉度高，生态成熟
   - PostgreSQL功能更强大，但学习成本高

### 9.2 技术亮点

1. **配置化设计**：SQL查询和数据库配置分离
2. **优雅的动画**：CSS过渡和关键帧动画结合
3. **响应式布局**：Grid和Flexbox实现自适应
4. **安全性考虑**：密码哈希、SQL注入防护

### 9.3 未来优化方向

1. **前端框架**：考虑引入Vue.js实现更复杂的交互
2. **数据库连接池**：使用SQLAlchemy管理数据库连接
3. **缓存系统**：引入Redis缓存热门查询
4. **图片CDN**：使用CDN加速图片加载
5. **API设计**：将部分功能改为RESTful API

---

## 附录：依赖包清单

```
Flask==3.0.0                    # Web框架
mysql-connector-python==8.2.0   # MySQL连接器
Werkzeug==3.0.1                 # WSGI工具库（密码哈希）
pandas                          # 数据处理（Excel导入）
```

---

**文档版本**：v1.0  
**最后更新**：2024年12月  
**维护者**：项目开发团队

