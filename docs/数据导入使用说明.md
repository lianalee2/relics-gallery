# 数据导入使用说明

## 🔧 已修复的问题

之前NPM导入脚本使用了 `TRUNCATE TABLE` 会清空所有表的数据，导致大都会数据被覆盖。现在已经修复：

- ✅ NPM导入脚本：只删除NPM来源（Source_ID）的数据
- ✅ MET导入脚本：只删除MET来源（Source_ID）的数据
- ✅ 两个脚本可以独立运行，不会互相覆盖

---

## 📝 导入脚本说明

### 1. NPM博物馆（国立故宫博物院）数据导入

**脚本位置：** `database_npm/data_importer_multi_table.py`

**Excel文件：** `database_npm/内容清单_with_sizes.xlsx`

**导入逻辑：**
- 查找或创建NPM的Source_ID（Museum_Code = 'NPM'）
- 删除该Source_ID的所有旧数据（文物、图像、属性、尺寸）
- 导入新的NPM数据

**运行方式：**
```powershell
cd database_npm
python data_importer_multi_table.py
```

或者从项目根目录：
```powershell
python database_npm/data_importer_multi_table.py
```

---

### 2. 大都会博物馆（MET）数据导入

**脚本位置：** `database/load.py`

**Excel文件：** `database/data.xlsx`

**导入逻辑：**
- 查找或创建MET的Source_ID（Museum_Code = 'MET'）
- 删除该Source_ID的所有旧数据（文物、图像、属性、尺寸）
- 导入新的MET数据

**运行方式：**
```powershell
cd database
python load.py
```

或者从项目根目录：
```powershell
python database/load.py
```

---

## 🚀 重新导入大都会数据

由于之前NPM导入脚本清空了大都会数据，现在需要重新导入：

### 步骤1：确认Excel文件存在

检查文件是否存在：
```powershell
Test-Path database\data.xlsx
```

### 步骤2：确认数据库配置

检查 `database/load.py` 中的数据库配置是否正确：
```python
DB_CONFIG = {
    'host': 'localhost',
    'user': 'root',
    'password': '你的密码',  # 修改为实际密码
    'database': 'project'
}
```

或者使用环境变量：
```powershell
$env:DB_PASSWORD="你的密码"
```

### 步骤3：运行导入脚本

从项目根目录运行：
```powershell
python database/load.py
```

或者进入database目录运行：
```powershell
cd database
python load.py
```

### 步骤4：验证导入结果

导入完成后，您应该看到类似输出：
```
成功导入第 1 条: ...
成功导入第 2 条: ...
...
任务完成！共导入 XX 条文物数据。
```

---

## 🔄 导入顺序建议

两个导入脚本可以按任意顺序运行，不会互相影响：

### 方案一：先导入大都会，再导入NPM
```powershell
# 1. 导入大都会数据
python database/load.py

# 2. 导入NPM数据
python database_npm/data_importer_multi_table.py
```

### 方案二：先导入NPM，再导入大都会
```powershell
# 1. 导入NPM数据
python database_npm/data_importer_multi_table.py

# 2. 导入大都会数据
python database/load.py
```

---

## ✅ 安全特性

### 1. 按Source_ID删除

两个脚本都只删除自己Source_ID的数据：

**NPM脚本：**
- 只删除 `Source_ID = NPM的ID` 的数据
- 不会影响MET的数据

**MET脚本：**
- 只删除 `Source_ID = MET的ID` 的数据
- 不会影响NPM的数据

### 2. 外键约束处理

删除时临时禁用外键检查，确保删除顺序正确：
```sql
SET FOREIGN_KEY_CHECKS = 0
-- 删除关联表数据
-- 删除主表数据
SET FOREIGN_KEY_CHECKS = 1
```

### 3. 事务管理

- NPM脚本：逐条提交，单条失败不影响其他数据
- MET脚本：批量提交，全部成功才提交

---

## 📊 Source_ID 管理

系统会自动管理Source_ID：

| Museum_Code | Museum_Name_CN | 说明 |
|------------|----------------|------|
| MET | 大都会艺术博物馆 | MET导入脚本使用 |
| NPM | 国立故宫博物院 | NPM导入脚本使用 |

如果Source已存在，脚本会复用现有的Source_ID；如果不存在，会自动创建。

---

## 🔍 验证数据

### 检查Source表

在MySQL中执行：
```sql
SELECT * FROM SOURCES;
```

应该看到至少两条记录（MET和NPM）。

### 检查文物数量

```sql
-- 查看各来源的文物数量
SELECT s.Museum_Name_CN, COUNT(a.Artifact_PK) as count
FROM SOURCES s
LEFT JOIN ARTIFACTS a ON s.Source_ID = a.Source_ID
GROUP BY s.Source_ID;
```

### 检查图像数量

```sql
-- 查看各来源的图像数量
SELECT s.Museum_Name_CN, COUNT(iv.Version_PK) as image_count
FROM SOURCES s
LEFT JOIN ARTIFACTS a ON s.Source_ID = a.Source_ID
LEFT JOIN IMAGE_VERSIONS iv ON a.Artifact_PK = iv.Artifact_PK
GROUP BY s.Source_ID;
```

---

## ⚠️ 注意事项

1. **备份数据库**：在生产环境运行前，建议先备份数据库
2. **Excel格式**：确保Excel文件格式正确，字段名称匹配
3. **数据库连接**：确保数据库配置正确，有足够的权限
4. **重复运行**：脚本可以安全地重复运行，会自动删除旧数据并导入新数据

---

## 🐛 故障排查

### 问题：导入失败，提示外键约束错误

**解决：** 脚本已处理外键约束，如果仍出现错误，检查数据库结构是否正确。

### 问题：导入后看不到数据

**解决：** 
1. 检查Source_ID是否正确
2. 检查数据库连接配置
3. 查看脚本输出的错误信息

### 问题：两个来源的数据互相覆盖

**解决：** 已修复，每个脚本只删除自己Source_ID的数据。如果仍出现，检查Source_ID是否正确识别。

---

## 📚 相关文件

- `database/load.py` - MET数据导入脚本
- `database/data.xlsx` - MET数据文件
- `database_npm/data_importer_multi_table.py` - NPM数据导入脚本
- `database_npm/内容清单_with_sizes.xlsx` - NPM数据文件

