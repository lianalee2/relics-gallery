# 后台管理功能使用指南

## 📍 如何进入后台管理系统

### 登录入口

1. **访问登录页面**
   ```
   http://localhost:5000/admin/login
   ```
   或
   ```
   http://127.0.0.1:5000/admin/login
   ```

2. **默认管理员密码**
   - 默认密码：`admin123`
   - 可以通过环境变量 `ADMIN_PASSWORD` 修改密码

3. **设置自定义密码（可选）**
   ```powershell
   # PowerShell
   $env:ADMIN_PASSWORD="你的新密码"
   ```

---

## 🔐 认证机制

### 权限控制

系统使用 Flask Session 来管理管理员登录状态：

- **登录标识**：`session['is_admin'] = True`
- **登录时间**：`session['admin_login_time']` 记录登录时间
- **权限装饰器**：所有管理员路由都使用 `@admin_required` 装饰器保护

### 安全特性

- ✅ 所有管理员页面都需要先登录
- ✅ 未登录访问会自动跳转到登录页面
- ✅ 支持安全登出功能

---

## 📊 后台管理功能模块

### 1. 管理员仪表板 (`/admin/dashboard`)

**功能：**
- 实时统计信息展示
  - 文物总数
  - 图片总数
  - 来源机构数
  - 近7天新增文物数
- 最近操作日志（显示最近10条）
- 按来源机构统计文物数量

**访问方式：**
- 登录后自动跳转
- 或直接访问：`http://localhost:5000/admin/dashboard`

---

### 2. 元数据批量导入 (`/admin/import`)

**功能：**
- 支持 CSV/Excel 文件上传
- 拖拽上传支持
- 下载标准导入模板
- 重复记录处理（跳过/更新模式）
- 实时导入反馈
- 错误处理和日志记录

**使用步骤：**

1. 访问 `/admin/import`
2. 点击"下载模板"获取标准格式
3. 填写文物数据（必需字段：Source_ID, Original_ID, Title_CN）
4. 上传文件（拖拽或点击选择）
5. 选择重复记录处理方式：
   - **跳过模式**：保留原有记录，跳过重复项
   - **更新模式**：用新数据覆盖原有记录
6. 点击"开始导入"
7. 查看导入结果统计

**支持的字段：**
- **必需字段**：Source_ID, Original_ID, Title_CN
- **可选字段**：Title_EN, Description_CN, Classification, Material, Date_CN, Date_EN, Start_Year, End_Year, Geography, Culture, Artist, Credit_Line, Page_Link, Size_Type, Size_Value, Size_Unit

---

### 3. 图像管理 (`/admin/images`)

**功能：**
- 图像列表展示（分页，每页50张）
- 图像预览
- 图像替换功能
- 文件大小追踪
- 更新时间追踪
- 操作日志记录

**使用方式：**

1. 访问 `/admin/images`
2. 浏览图像列表（支持分页）
3. 点击"替换图像"可以上传新图片替换现有图像
4. 系统会自动记录替换操作到日志

---

### 4. 操作日志查看 (`/admin/logs`)

**功能：**
- 日志列表展示（最多显示1000条）
- 多维度筛选：
  - 操作类型（INSERT/UPDATE/DELETE/IMAGE_REPLACE）
  - 数据表（ARTIFACTS/IMAGE_VERSIONS/PROPERTIES等）
  - 日期范围
- 日志详情显示：
  - 操作时间
  - 操作类型和数据表
  - 关联的文物链接
  - 操作人
  - 状态（Success/Failed）
  - 详细描述

**使用方式：**

1. 访问 `/admin/logs`
2. 使用筛选条件（可选）：
   - 选择操作类型
   - 选择数据表
   - 设置日期范围
3. 点击"应用筛选"
4. 查看日志详情

---

## 🔗 路由列表

| 路由 | 方法 | 说明 | 权限要求 |
|------|------|------|----------|
| `/admin/login` | GET/POST | 管理员登录页面 | 无 |
| `/admin/logout` | GET | 管理员登出 | 无 |
| `/admin/dashboard` | GET | 管理员仪表板 | 需要登录 |
| `/admin/import` | GET/POST | 元数据导入 | 需要登录 |
| `/admin/images` | GET | 图像管理 | 需要登录 |
| `/admin/image/replace/<id>` | POST | 替换图像 | 需要登录 |
| `/admin/logs` | GET | 操作日志 | 需要登录 |
| `/admin/api/download_template` | GET | 下载导入模板 | 需要登录 |

---

## 💻 代码实现位置

### 核心代码文件

- **路由定义**：`app.py` 第 2181-2796 行
- **权限装饰器**：`app.py` 第 2183-2191 行
- **登录逻辑**：`app.py` 第 2195-2218 行

### 模板文件

- `templates/admin_login.html` - 登录页面
- `templates/admin_dashboard.html` - 仪表板
- `templates/admin_import.html` - 导入页面
- `templates/admin_images.html` - 图像管理
- `templates/admin_logs.html` - 日志查看

### 配置说明

**管理员密码配置位置**（`app.py` 第 2181 行）：
```python
ADMIN_PASSWORD = os.getenv('ADMIN_PASSWORD', 'admin123')
```

优先使用环境变量，如果没有设置环境变量则使用默认密码 `admin123`。

---

## 🛡️ 安全建议

1. **修改默认密码**
   ```powershell
   $env:ADMIN_PASSWORD="你的安全密码"
   ```

2. **生产环境建议**
   - 使用强密码
   - 定期更换密码
   - 不要将密码硬编码在代码中
   - 使用 HTTPS 加密连接

3. **访问控制**
   - 所有管理员路由都受 `@admin_required` 保护
   - 未登录用户无法访问任何管理功能

---

## 🚀 快速开始

1. **启动应用**
   ```bash
   python app.py
   ```

2. **访问登录页面**
   打开浏览器访问：`http://localhost:5000/admin/login`

3. **输入密码登录**
   - 默认密码：`admin123`
   - 或使用您通过环境变量设置的密码

4. **进入仪表板**
   登录成功后自动跳转到 `/admin/dashboard`

5. **开始使用**
   根据需要使用各个管理功能模块

---

## 📝 注意事项

- ✅ 所有操作都会记录到 `LOGS` 表中
- ✅ 导入功能支持大数据量，但建议分批导入
- ✅ 图像替换会保持原有路径，只更新文件内容
- ✅ 日志查看最多显示1000条记录
- ⚠️ 批量导入时请注意重复记录的处理方式选择

---

## 🔍 故障排查

### 无法登录
- 检查密码是否正确（默认：`admin123`）
- 检查环境变量是否设置正确
- 查看浏览器控制台是否有错误信息

### 无法访问管理页面
- 确认已登录（检查 `session['is_admin']`）
- 尝试重新登录
- 检查数据库连接是否正常

### 导入功能异常
- 检查文件格式是否为 CSV 或 Excel
- 确认必需字段已填写
- 查看错误日志了解详细信息

---

## 📚 相关文档

- `ADMIN_FEATURES_CHECKLIST.md` - 功能检查清单
- `README.md` - 项目整体说明
- `数据库连接问题解决方案.md` - 数据库连接问题解决

