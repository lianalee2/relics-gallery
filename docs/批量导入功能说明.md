# 批量导入功能使用说明

## 📋 功能概述

系统已实现使用**存储过程**进行批量导入文化遗产图像元数据信息，所有导入操作的成功和失败都会自动记录到系统操作日志中。

---

## 🗄️ 数据库对象

### 1. 存储过程：`sp_import_artifact_metadata`

**功能：** 批量导入文化遗产图像元数据信息

**参数：**
- 输入参数：Source_ID, Original_ID, Title_CN, Title_EN, Description_CN, Classification, Material, Date_CN, Date_EN, Start_Year, End_Year, Geography, Culture, Artist, Credit_Line, Page_Link, Size_Type, Size_Value, Size_Unit, Image_Link, Local_Path, Version_Type, User_ID, Import_Mode
- 输出参数：Artifact_ID, Result_Status, Result_Message

**逻辑：**
- 根据 Source_ID + Original_ID 检查是否已存在
- 支持两种模式：
  - `skip`：跳过已存在的记录
  - `update`：更新已存在的记录
- 自动插入/更新 ARTIFACTS, PROPERTIES, DIMENSIONS, IMAGE_VERSIONS 表
- 自动记录操作日志到 LOGS 表

### 2. 存储过程：`sp_log_import_error`

**功能：** 记录导入失败的日志

**用途：** 当导入过程中出现错误时，调用此存储过程记录详细错误信息

### 3. 触发器：`image_replace_log`

**功能：** 当图像文件被替换时，自动记录替换时间、操作人及原文件路径

**触发时机：** IMAGE_VERSIONS 表的 Local_Path 或 Image_Link 字段更新时

**记录内容：**
- 替换时间（自动设置为当前时间）
- 操作人（数据库用户）
- 原文件路径（OLD.Local_Path）
- 新文件路径（NEW.Local_Path）
- 原网络链接（OLD.Image_Link）
- 新网络链接（NEW.Image_Link）
- 自动更新 Last_Processed_Time 字段

---

## 📝 安装步骤

### 1. 执行SQL脚本

在MySQL中执行以下命令：

```bash
mysql -u root -p project < sql/database_procedures_and_triggers.sql
```

或者在MySQL客户端中：

```sql
SOURCE sql/database_procedures_and_triggers.sql;
```

### 2. 验证安装

检查存储过程和触发器是否创建成功：

```sql
-- 检查存储过程
SHOW PROCEDURE STATUS WHERE Db = 'project';

-- 检查触发器
SHOW TRIGGERS FROM project;
```

应该看到：
- `sp_import_artifact_metadata` 存储过程
- `sp_log_import_error` 存储过程
- `image_replace_log` 触发器

---

## 🚀 使用方法

### 后台批量导入

1. **登录管理员后台**
   - 访问：`http://localhost:5000/admin/login`
   - 输入管理员密码

2. **进入导入页面**
   - 访问：`http://localhost:5000/admin/import`
   - 或从仪表板导航到"批量导入"

3. **准备Excel/CSV文件**

   **必需列：**
   - `Source_ID`：来源机构ID（整数）
   - `Original_ID`：原始编号（字符串）
   - `Title_CN`：中文标题（字符串）

   **可选列：**
   - `Title_EN`：英文标题
   - `Description_CN`：中文描述
   - `Classification`：分类
   - `Material`：材质
   - `Date_CN`：中文年代
   - `Date_EN`：英文年代
   - `Start_Year`：起始年份
   - `End_Year`：结束年份
   - `Geography`：地理
   - `Culture`：文化
   - `Artist`：艺术家
   - `Credit_Line`：版权说明
   - `Page_Link`：页面链接
   - `Size_Type`：尺寸类型
   - `Size_Value`：尺寸值
   - `Size_Unit`：尺寸单位
   - `Image_Link`：图像链接
   - `Local_Path`：本地路径
   - `Version_Type`：版本类型

4. **上传并导入**
   - 选择文件（支持 .csv, .xlsx, .xls）
   - 选择导入模式：
     - **跳过模式**：已存在的记录保持不变
     - **更新模式**：已存在的记录用新数据覆盖
   - 点击"开始导入"

5. **查看结果**
   - 导入完成后会显示统计信息
   - 所有操作（成功/失败）都会记录到系统日志
   - 可以在 `/admin/logs` 查看详细日志

---

## 📊 日志记录

### 导入成功日志

每条成功导入的记录会创建一条日志：
- **Operation_Type**：`INSERT` 或 `UPDATE`
- **Status**：`Success`
- **Description**：包含文物标题和操作类型
- **User_ID**：导入操作的用户名

### 导入失败日志

每条失败的记录会创建一条日志：
- **Operation_Type**：`BATCH_IMPORT`
- **Status**：`Failed`
- **Description**：包含行号、文物标题和详细错误信息
- **User_ID**：导入操作的用户名

### 图像替换日志

每次图像替换会由触发器自动创建日志：
- **Operation_Type**：`IMAGE_REPLACE`
- **Status**：`Success`
- **Description**：包含原文件路径、新文件路径等信息
- **Log_Time**：替换时间（自动记录）
- **User_ID**：操作人（会更新为应用层用户名）

---

## 🔍 查看日志

### 在后台管理页面查看

1. 访问：`http://localhost:5000/admin/logs`
2. 可以筛选：
   - 操作类型（INSERT, UPDATE, DELETE, IMAGE_REPLACE, BATCH_IMPORT）
   - 数据表（ARTIFACTS, IMAGE_VERSIONS, PROPERTIES等）
   - 日期范围
   - 状态（Success, Failed）

### 在数据库中查看

```sql
-- 查看所有导入日志
SELECT * FROM LOGS 
WHERE Operation_Type IN ('INSERT', 'UPDATE', 'BATCH_IMPORT')
ORDER BY Log_Time DESC;

-- 查看图像替换日志
SELECT * FROM LOGS 
WHERE Operation_Type = 'IMAGE_REPLACE'
ORDER BY Log_Time DESC;

-- 查看失败的导入记录
SELECT * FROM LOGS 
WHERE Status = 'Failed' 
AND Operation_Type = 'BATCH_IMPORT'
ORDER BY Log_Time DESC;
```

---

## ⚙️ 技术实现

### 存储过程调用

Python代码通过以下方式调用存储过程：

```python
cursor.execute("""
    CALL sp_import_artifact_metadata(
        %s, %s, %s, ..., 
        @p_artifact_id, @p_result_status, @p_result_message
    )
""", (参数列表))

# 获取输出参数
cursor.execute("SELECT @p_artifact_id, @p_result_status, @p_result_message")
result = cursor.fetchone()
```

### 触发器自动记录

触发器在数据库层面自动工作，无需应用层代码干预：

```sql
CREATE TRIGGER image_replace_log
BEFORE UPDATE ON IMAGE_VERSIONS
FOR EACH ROW
BEGIN
    -- 检查路径是否变化
    IF (NEW.Local_Path <=> OLD.Local_Path IS FALSE) THEN
        -- 自动插入日志记录
        INSERT INTO LOGS (...);
        -- 自动更新处理时间
        SET NEW.Last_Processed_Time = NOW();
    END IF;
END;
```

---

## ✅ 课程要求验证

### ✅ 要求1：编写存储过程来批量导入文化遗产图像元数据信息

**实现：**
- ✅ 存储过程 `sp_import_artifact_metadata` 实现了完整的批量导入逻辑
- ✅ 支持插入新记录和更新已有记录
- ✅ 自动处理多表关联（ARTIFACTS, PROPERTIES, DIMENSIONS, IMAGE_VERSIONS）
- ✅ 支持跳过模式和更新模式

### ✅ 要求2：导入的成功或失败在系统操作日志显示

**实现：**
- ✅ 存储过程自动记录成功日志
- ✅ 调用 `sp_log_import_error` 记录失败日志
- ✅ 所有日志记录在 LOGS 表中
- ✅ 后台管理页面可以查看所有日志

### ✅ 要求3：创建触发器，当图像文件被替换时，自动记录替换时间、操作人及原文件路径

**实现：**
- ✅ 触发器 `image_replace_log` 在 IMAGE_VERSIONS 表更新时触发
- ✅ 自动记录替换时间（通过 Log_Time 字段，默认为 CURRENT_TIMESTAMP）
- ✅ 自动记录操作人（通过 USER() 函数，并更新为应用层用户名）
- ✅ 自动记录原文件路径（OLD.Local_Path）
- ✅ 自动记录新文件路径（NEW.Local_Path）
- ✅ 自动更新 Last_Processed_Time 字段

---

## 🐛 故障排查

### 问题：存储过程调用失败

**检查：**
1. 确认已执行 `sql/database_procedures_and_triggers.sql`
2. 检查存储过程是否存在：`SHOW PROCEDURE STATUS WHERE Db = 'project';`
3. 检查参数是否正确传递

### 问题：触发器未触发

**检查：**
1. 确认触发器存在：`SHOW TRIGGERS FROM project;`
2. 确认更新的是 Local_Path 或 Image_Link 字段
3. 检查是否有权限执行触发器

### 问题：日志未记录

**检查：**
1. 检查 LOGS 表是否存在
2. 检查是否有插入权限
3. 查看MySQL错误日志

---

## 📚 相关文件

- `sql/database_procedures_and_triggers.sql` - 存储过程和触发器定义
- `app.py` - 应用代码（导入功能实现）
- `templates/admin_import.html` - 导入页面模板
- `templates/admin_logs.html` - 日志查看页面模板

