{% extends 'base.html' %}

{% block title %}{{ album.name }} - æˆ‘çš„å›¾é›†{% endblock %}

{% block content %}
<style>
    /* å›¾é›†è¯¦æƒ…é¡µæ ·å¼ */
    .album-detail-header {
        background-color: var(--color-white);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 30px;
        margin-bottom: 30px;
        display: flex;
        gap: 30px;
        align-items: center;
    }
    
    /* å›¾é›†å°é¢ï¼ˆæ¨¡ç³Šæ•ˆæœï¼‰ */
    .album-cover-container {
        width: 200px;
        height: 200px;
        border-radius: 8px;
        overflow: hidden;
        flex-shrink: 0;
        background-color: var(--color-lavender);
        position: relative;
    }
    
    .album-cover-blur {
        width: 100%;
        height: 100%;
        object-fit: cover;
        filter: blur(8px);
        transform: scale(1.2);
    }
    
    .album-cover-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(158, 151, 176, 0.3) 0%, rgba(74, 69, 87, 0.2) 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--color-white);
        font-size: 1rem;
        font-weight: bold;
        text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }
    
    .album-header-info {
        flex: 1;
    }
    
    .album-header-title {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 10px;
        color: var(--color-text);
    }
    
    .album-header-meta {
        color: #666;
        font-size: 1rem;
        margin-bottom: 15px;
    }
    
    .album-header-actions {
        display: flex;
        gap: 15px;
        margin-top: 20px;
    }
    
    .album-action-btn {
        padding: 10px 20px;
        border: 1px solid var(--color-text);
        background-color: var(--color-white);
        color: var(--color-text);
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
        text-decoration: none;
        transition: all 0.2s;
        display: inline-block;
    }
    
    .album-action-btn:hover {
        background-color: var(--color-accent);
        color: var(--color-white);
        border-color: var(--color-accent);
    }
    
    /* æ–‡ç‰©å¡ç‰‡ç½‘æ ¼ï¼ˆä¸ culture_detail.html ä¸€è‡´ï¼‰ */
    .catalog-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 30px;
    }

    .card {
        background-color: var(--color-white);
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        transition: transform 0.2s;
        cursor: pointer;
        text-decoration: none;
        color: inherit;
        display: block;
    }

    .card:hover {
        transform: translateY(-5px);
    }

    .card-image-wrapper {
        height: 200px;
        width: 100%;
        background-color: #eee;
        overflow: hidden;
    }

    .card-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .card-info {
        padding: 15px;
    }

    .card-title {
        font-size: 1.1rem;
        font-weight: bold;
        margin-bottom: 5px;
        color: var(--color-text);
    }

    .card-date {
        font-size: 0.9rem;
        color: #888;
    }
    
    /* æ–‡ç‰©å¡ç‰‡åˆ é™¤æŒ‰é’® */
    .card {
        position: relative;
    }
    
    .card-remove-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background-color: rgba(255, 255, 255, 0.9);
        border: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.2s;
        z-index: 10;
        font-size: 1rem;
    }
    
    .card:hover .card-remove-btn {
        opacity: 1;
    }
    
    .card-remove-btn:hover {
        background-color: #f8d7da;
        color: #721c24;
        border-color: #f5c6cb;
        transform: scale(1.1);
    }
    
    /* ç©ºçŠ¶æ€æ ·å¼ */
    .empty-album {
        text-align: center;
        padding: 60px 20px;
        background-color: var(--color-white);
        border: 1px solid var(--border-color);
        border-radius: 8px;
    }
    
    .empty-album-icon {
        font-size: 4rem;
        color: #ccc;
        margin-bottom: 20px;
    }
    
    .empty-album-text {
        font-size: 1.1rem;
        color: #666;
        margin-bottom: 30px;
    }
    
    /* ç®¡ç†æ¨¡æ€æ¡†æ ·å¼ */
    .manage-modal {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
    }
    
    .manage-modal-content {
        background-color: var(--color-white);
        margin: 15% auto;
        padding: 30px;
        border-radius: 8px;
        width: 90%;
        max-width: 400px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        position: relative;
    }
    
    .manage-modal-header {
        font-size: 1.3rem;
        font-weight: bold;
        margin-bottom: 20px;
        color: var(--color-text);
    }
    
    .manage-modal-body {
        margin-bottom: 25px;
    }
    
    .manage-modal-body p {
        margin: 10px 0;
        color: var(--color-text);
    }
    
    .manage-modal-input {
        width: 100%;
        padding: 10px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        font-size: 1rem;
        box-sizing: border-box;
    }
    
    .manage-modal-input:focus {
        outline: none;
        border-color: var(--color-primary);
    }
    
    .manage-modal-buttons {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
    }
    
    .manage-modal-btn {
        padding: 10px 20px;
        border: 1px solid var(--color-text);
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.2s;
    }
    
    .manage-modal-btn-primary {
        background-color: var(--color-text);
        color: var(--color-white);
        border-color: var(--color-text);
    }
    
    .manage-modal-btn-secondary {
        background-color: var(--color-white);
        color: var(--color-text);
    }
    
    .manage-modal-btn:hover {
        background-color: var(--color-accent);
        color: var(--color-white);
        border-color: var(--color-accent);
    }
</style>

<div style="margin-bottom: 20px;">
    <a class="back-link" href="{{ url_for('user_center') }}">&larr; è¿”å›ç”¨æˆ·ä¸­å¿ƒ</a>
</div>

<!-- å›¾é›†å¤´éƒ¨ä¿¡æ¯ -->
<div class="album-detail-header">
    <div class="album-cover-container">
        {% if artifacts and artifacts[0].local_path %}
            <img src="{{ url_for('static', filename=artifacts[0].local_path) }}" 
                 alt="{{ album.name }}" 
                 class="album-cover-blur">
            <div class="album-cover-overlay">
                {{ album.item_count }} ä»¶æ–‡ç‰©
            </div>
        {% else %}
            <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: #999; font-size: 0.9rem;">
                [æš‚æ— å°é¢]
            </div>
        {% endif %}
    </div>
    
    <div class="album-header-info">
        <h1 class="album-header-title">{{ album.name }}</h1>
        <div class="album-header-meta">
            {{ artifacts|length }} ä¸ªå†…å®¹ â€¢ 
            {% if album.is_public %}å…¬å¼€{% else %}ç§å¯†{% endif %}
            {% if album.created_at %}
                â€¢ åˆ›å»ºäº {{ album.created_at.strftime('%Y-%m-%d') if album.created_at is not string else album.created_at }}
            {% endif %}
        </div>
        
        <div class="album-header-actions">
            <button class="album-action-btn" onclick="window.location.href='{{ url_for('random_browse') }}'">
                ç»§ç»­æ·»åŠ æ–‡ç‰©
            </button>
            <button class="album-action-btn">
                å¯¼å‡ºæ•°æ®
            </button>
            <button class="album-action-btn">
                åˆ†äº«å›¾é›†
            </button>
            {% if album.album_id != 'guest_default' and session.get('user_id') %}
            <button class="album-action-btn" onclick="openRenameModal({{ album.album_id }}, {{ album.name|tojson }})" style="background-color: #d1ecf1; color: #0c5460; border-color: #bee5eb;">
                é‡å‘½åå›¾é›†
            </button>
            {% if album.name != 'é»˜è®¤æ”¶è—å¤¹' %}
            <button class="album-action-btn" onclick="openDeleteModal({{ album.album_id }}, {{ album.name|tojson }})" style="background-color: #f8d7da; color: #721c24; border-color: #f5c6cb;">
                åˆ é™¤å›¾é›†
            </button>
            {% endif %}
            {% endif %}
        </div>
    </div>
</div>

<!-- æ–‡ç‰©åˆ—è¡¨ -->
{% if artifacts %}
<div style="margin-bottom: 20px;">
    <h2 style="font-size: 1.5rem; color: var(--color-text);">å›¾é›†å†…å®¹</h2>
</div>

<div class="catalog-grid">
    {% for item in artifacts %}
    <div class="card" style="position: relative;">
        <a href="{{ url_for('detail', artifact_id=item.artifact_id) }}" style="text-decoration: none; color: inherit; display: block;">
            <div class="card-image-wrapper">
                {% if item.local_path %}
                    <img src="{{ url_for('static', filename=item.local_path) }}" alt="{{ item.title }}" class="card-image">
                {% else %}
                    <div class="card-image" style="display:flex;align-items:center;justify-content:center;color:#999;">æš‚æ— å›¾ç‰‡</div>
                {% endif %}
            </div>
            <div class="card-info">
                <div class="card-title">{{ item.title or 'æœªå‘½åæ–‡ç‰©' }}</div>
                <div class="card-date">{{ item.date_text or 'å¹´ä»£æœªçŸ¥' }}</div>
            </div>
        </a>
        {% if album.album_id != 'guest_default' and session.get('user_id') %}
        <button class="card-remove-btn" onclick="event.stopPropagation(); openRemoveArtifactModal({{ album.album_id }}, {{ item.artifact_id }}, {{ (item.title or 'æœªå‘½åæ–‡ç‰©')|tojson }}); return false;" title="ä»å›¾é›†ä¸­ç§»é™¤">Ã—</button>
        {% endif %}
    </div>
    {% endfor %}
</div>
{% else %}
<!-- ç©ºçŠ¶æ€ -->
<div class="empty-album">
    <div class="empty-album-icon">ğŸ“¦</div>
    <div class="empty-album-text">å›¾é›†ä¸­è¿˜æ²¡æœ‰å†…å®¹</div>
    <button class="album-action-btn" onclick="window.location.href='{{ url_for('random_browse') }}'">
        å¼€å§‹æ·»åŠ æ–‡ç‰©
    </button>
</div>
{% endif %}

<!-- åˆ é™¤å›¾é›†ç¡®è®¤æ¨¡æ€æ¡† -->
<div id="deleteAlbumModal" class="manage-modal">
    <div class="manage-modal-content">
        <div class="manage-modal-header">åˆ é™¤å›¾é›†</div>
        <div class="manage-modal-body">
            <p>ç¡®å®šè¦åˆ é™¤å›¾é›† "<span id="delete-album-name-detail"></span>" å—ï¼Ÿ</p>
            <p style="color: #999; font-size: 0.9rem; margin-top: 10px;">æ­¤æ“ä½œä¸å¯æ¢å¤ï¼Œå›¾é›†ä¸­çš„æ‰€æœ‰æ–‡ç‰©å°†è¢«ç§»é™¤ã€‚</p>
        </div>
        <div class="manage-modal-buttons">
            <button class="manage-modal-btn manage-modal-btn-secondary" onclick="closeManageModal('deleteAlbumModal')">å–æ¶ˆ</button>
            <button class="manage-modal-btn manage-modal-btn-primary" id="confirm-delete-btn-detail">ç¡®è®¤åˆ é™¤</button>
        </div>
    </div>
</div>

<!-- é‡å‘½åå›¾é›†æ¨¡æ€æ¡† -->
<div id="renameAlbumModal" class="manage-modal">
    <div class="manage-modal-content">
        <div class="manage-modal-header">é‡å‘½åå›¾é›†</div>
        <div class="manage-modal-body">
            <label style="display: block; margin-bottom: 8px; font-weight: bold;">æ–°åç§°ï¼š</label>
            <input type="text" id="rename-album-input-detail" class="manage-modal-input" placeholder="è¾“å…¥å›¾é›†åç§°">
        </div>
        <div class="manage-modal-buttons">
            <button class="manage-modal-btn manage-modal-btn-secondary" onclick="closeManageModal('renameAlbumModal')">å–æ¶ˆ</button>
            <button class="manage-modal-btn manage-modal-btn-primary" id="confirm-rename-btn-detail">ç¡®è®¤</button>
        </div>
    </div>
</div>

<!-- åˆ é™¤æ–‡ç‰©ç¡®è®¤æ¨¡æ€æ¡† -->
<div id="removeArtifactModal" class="manage-modal">
    <div class="manage-modal-content">
        <div class="manage-modal-header">ç§»é™¤æ–‡ç‰©</div>
        <div class="manage-modal-body">
            <p>ç¡®å®šè¦ä»å›¾é›†ä¸­ç§»é™¤ "<span id="remove-artifact-name"></span>" å—ï¼Ÿ</p>
        </div>
        <div class="manage-modal-buttons">
            <button class="manage-modal-btn manage-modal-btn-secondary" onclick="closeManageModal('removeArtifactModal')">å–æ¶ˆ</button>
            <button class="manage-modal-btn manage-modal-btn-primary" id="confirm-remove-artifact-btn">ç¡®è®¤ç§»é™¤</button>
        </div>
    </div>
</div>

<script>
    {% if album.album_id != 'guest_default' %}
    const albumId = {{ album.album_id }};
    {% else %}
    const albumId = null;
    {% endif %}
    
    // æ‰“å¼€åˆ é™¤å›¾é›†æ¨¡æ€æ¡†
    function openDeleteModal(albumId, albumName) {
        document.getElementById('delete-album-name-detail').textContent = albumName;
        document.getElementById('deleteAlbumModal').style.display = 'block';
        
        // è®¾ç½®ç¡®è®¤æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
        const confirmBtn = document.getElementById('confirm-delete-btn-detail');
        confirmBtn.onclick = function() {
            deleteAlbum(albumId, albumName);
        };
    }
    
    // æ‰“å¼€é‡å‘½åå›¾é›†æ¨¡æ€æ¡†
    function openRenameModal(albumId, currentName) {
        document.getElementById('rename-album-input-detail').value = currentName;
        document.getElementById('renameAlbumModal').style.display = 'block';
        
        // è®¾ç½®ç¡®è®¤æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
        const confirmBtn = document.getElementById('confirm-rename-btn-detail');
        confirmBtn.onclick = function() {
            const newName = document.getElementById('rename-album-input-detail').value.trim();
            if (!newName || newName === '') {
                alert('å›¾é›†åç§°ä¸èƒ½ä¸ºç©º');
                return;
            }
            if (newName === currentName) {
                closeManageModal('renameAlbumModal');
                return;
            }
            renameAlbum(albumId, newName);
        };
        
        // èšç„¦è¾“å…¥æ¡†
        setTimeout(() => {
            document.getElementById('rename-album-input-detail').focus();
            document.getElementById('rename-album-input-detail').select();
        }, 100);
    }
    
    // æ‰“å¼€åˆ é™¤æ–‡ç‰©æ¨¡æ€æ¡†
    function openRemoveArtifactModal(albumId, artifactId, artifactTitle) {
        document.getElementById('remove-artifact-name').textContent = artifactTitle;
        document.getElementById('removeArtifactModal').style.display = 'block';
        
        // è®¾ç½®ç¡®è®¤æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
        const confirmBtn = document.getElementById('confirm-remove-artifact-btn');
        confirmBtn.onclick = function() {
            removeArtifactFromAlbum(albumId, artifactId, artifactTitle);
        };
    }
    
    // å…³é—­ç®¡ç†æ¨¡æ€æ¡†
    function closeManageModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }
    
    // åˆ é™¤å›¾é›†
    function deleteAlbum(albumId, albumName) {
        fetch('/api/album/delete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                album_id: albumId
            })
        })
        .then(response => response.json())
        .then(data => {
            closeManageModal('deleteAlbumModal');
            if (data.success) {
                alert('å›¾é›†å·²åˆ é™¤');
                window.location.href = "{{ url_for('user_center') }}";
            } else {
                alert(data.message || 'åˆ é™¤å¤±è´¥');
            }
        })
        .catch(error => {
            console.error('åˆ é™¤å›¾é›†å¤±è´¥:', error);
            closeManageModal('deleteAlbumModal');
            alert('åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
        });
    }
    
    // é‡å‘½åå›¾é›†
    function renameAlbum(albumId, newName) {
        fetch('/api/album/rename', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                album_id: albumId,
                name: newName
            })
        })
        .then(response => response.json())
        .then(data => {
            closeManageModal('renameAlbumModal');
            if (data.success) {
                alert('å›¾é›†å·²é‡å‘½å');
                window.location.reload();
            } else {
                alert(data.message || 'é‡å‘½åå¤±è´¥');
            }
        })
        .catch(error => {
            console.error('é‡å‘½åå›¾é›†å¤±è´¥:', error);
            closeManageModal('renameAlbumModal');
            alert('é‡å‘½åå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
        });
    }
    
    // ä»å›¾é›†ä¸­ç§»é™¤æ–‡ç‰©
    function removeArtifactFromAlbum(albumId, artifactId, artifactTitle) {
        fetch('/api/album/remove_artifact', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                album_id: albumId,
                artifact_id: artifactId
            })
        })
        .then(response => response.json())
        .then(data => {
            closeManageModal('removeArtifactModal');
            if (data.success) {
                alert('å·²ä»å›¾é›†ä¸­ç§»é™¤');
                window.location.reload();
            } else {
                alert(data.message || 'ç§»é™¤å¤±è´¥');
            }
        })
        .catch(error => {
            console.error('ç§»é™¤æ–‡ç‰©å¤±è´¥:', error);
            closeManageModal('removeArtifactModal');
            alert('ç§»é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
        });
    }
    
    // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
    window.addEventListener('click', function(event) {
        const deleteModal = document.getElementById('deleteAlbumModal');
        const renameModal = document.getElementById('renameAlbumModal');
        const removeModal = document.getElementById('removeArtifactModal');
        if (event.target === deleteModal) {
            closeManageModal('deleteAlbumModal');
        }
        if (event.target === renameModal) {
            closeManageModal('renameAlbumModal');
        }
        if (event.target === removeModal) {
            closeManageModal('removeArtifactModal');
        }
    });
    
    // æ”¯æŒå›è½¦é”®ç¡®è®¤é‡å‘½å
    document.addEventListener('DOMContentLoaded', function() {
        const renameInput = document.getElementById('rename-album-input-detail');
        if (renameInput) {
            renameInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('confirm-rename-btn-detail').click();
                }
            });
        }
    });
</script>
{% endblock %}