{% extends 'base.html' %}

{% block title %}搜索结果 - 遗珍图库{% endblock %}

{% block content %}
<style>
    /* 搜索页面布局 */
    .search-page-container {
        max-width: 1400px;
        margin: 40px auto;
        padding: 0 20px;
        display: flex;
        gap: 30px;
    }

    /* 左侧筛选栏 */
    .filter-sidebar {
        width: 280px;
        flex-shrink: 0;
        background-color: var(--color-white);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 20px;
        height: fit-content;
        position: sticky;
        top: 100px;
    }

    .filter-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid var(--border-color);
    }

    .filter-title {
        font-size: 1.2rem;
        font-weight: bold;
        color: var(--color-text);
    }

    .clear-filter-btn {
        font-size: 0.85rem;
        color: var(--color-primary);
        background: none;
        border: none;
        cursor: pointer;
        padding: 5px 10px;
        border-radius: 4px;
        transition: background-color 0.2s;
    }

    .clear-filter-btn:hover {
        background-color: var(--color-lavender);
    }

    /* 激活的筛选标签 */
    .active-filters {
        margin-bottom: 20px;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }

    .filter-tag {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 5px 12px;
        background-color: var(--color-lavender);
        border-radius: 15px;
        font-size: 0.85rem;
        color: var(--color-text);
    }

    .filter-tag-remove {
        cursor: pointer;
        font-weight: bold;
        color: var(--color-text);
        opacity: 0.7;
    }

    /* 筛选分组 */
    .filter-group {
        margin-bottom: 25px;
    }

    .filter-group-title {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 1rem;
        font-weight: bold;
        margin-bottom: 12px;
        color: var(--color-text);
        cursor: pointer;
    }

    .filter-group-content {
        max-height: 800px;
        overflow: hidden;
        transition: max-height 0.3s ease;
    }

    .filter-group.collapsed .filter-group-content {
        max-height: 0;
    }

    /* 复选框列表 */
    .filter-checkbox-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .filter-checkbox-item {
        display: flex;
        align-items: center;
        padding: 8px 0;
    }

    .filter-checkbox-item input[type="checkbox"] {
        width: 17px;
        height: 17px;
        margin-right: 10px;
        accent-color: var(--color-primary);
    }

    .filter-checkbox-item label {
        flex: 1;
        font-size: 0.9rem;
        display: flex;
        justify-content: space-between;
        cursor: pointer;
    }

    /* 主内容区域 */
    .search-main {
        flex: 1;
        min-width: 0;
    }

    .search-header {
        margin-bottom: 20px;
    }

    .sort-bar {
        display: flex;
        justify-content: flex-end;
        margin-bottom: 25px;
        padding: 12px;
        background: #fff;
        border-radius: 8px;
        border: 1px solid var(--border-color);
    }

    /* 搜索结果网格 - 強制一致性 */
    .search-results-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
        gap: 25px;
    }

    .card {
        background: #fff;
        border: 1px solid var(--border-color);
        border-radius: 12px;
        overflow: hidden;
        text-decoration: none;
        color: inherit;
        transition: transform 0.3s, box-shadow 0.3s;
        display: flex;
        flex-direction: column;
    }

    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.08);
    }

    .card-image-wrapper {
        width: 100%;
        aspect-ratio: 4/3;
        background: #f8f8f8;
        overflow: hidden;
    }

    .card-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .card-info {
        padding: 15px;
    }

    .card-title {
        font-weight: bold;
        font-size: 1rem;
        margin-bottom: 5px;
        display: -webkit-box;
        -webkit-line-clamp: 1;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .card-date {
        font-size: 0.85rem;
        color: #8b4513;
    }

    /* 自定義年代輸入樣式 */
    .custom-era-input {
        padding: 12px;
        background: #fdfaf5;
        margin-top: 10px;
        border-radius: 6px;
        border: 1px solid #eee;
    }
</style>

<div class="search-page-container">
    <aside class="filter-sidebar">
        <div class="filter-header">
            <h3 class="filter-title">高级筛选</h3>
            <button class="clear-filter-btn" onclick="clearAllFilters()">清空</button>
        </div>

        <div class="active-filters">
            {% if active_filters %}
                {% for filter_type, filter_values in active_filters.items() %}
                    {% if filter_type == 'year_range' %}
                        <span class="filter-tag">
                            年代: {{ filter_values }}
                            <span class="filter-tag-remove" onclick="clearEra()">×</span>
                        </span>
                    {% else %}
                        {% for value in filter_values %}
                            <span class="filter-tag">
                                {{ value }}
                                <span class="filter-tag-remove" onclick="removeFilter('{{ filter_type }}', '{{ value }}')">×</span>
                            </span>
                        {% endfor %}
                    {% endif %}
                {% endfor %}
            {% endif %}
        </div>

        <div class="filter-group expanded">
            <div class="filter-group-title" onclick="toggleFilterGroup(this)">
                <span>文化</span>
                <span class="filter-group-toggle">−</span>
            </div>
            <div class="filter-group-content">
                <ul class="filter-checkbox-list">
                    {% for culture in filter_options.cultures|default([]) %}
                    <li class="filter-checkbox-item">
                        <input type="checkbox" name="culture" value="{{ culture.value }}"
                               {% if culture.value in active_filters.get('culture', []) %}checked{% endif %}
                               onchange="applyFilter('culture', '{{ culture.value }}', this.checked)">
                        <label>
                            <span>{{ culture.label }}</span>
                            <span class="filter-count">({{ culture.count }})</span>
                        </label>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>

        <div class="filter-group expanded">
            <div class="filter-group-title" onclick="toggleFilterGroup(this)">
                <span>材质</span>
                <span class="filter-group-toggle">−</span>
            </div>
            <div class="filter-group-content">
                <ul class="filter-checkbox-list">
                    {% for material in filter_options.materials|default([]) %}
                    <li class="filter-checkbox-item">
                        <input type="checkbox" name="material" value="{{ material.value }}"
                               {% if material.value in active_filters.get('material', []) %}checked{% endif %}
                               onchange="applyFilter('material', '{{ material.value }}', this.checked)">
                        <label>
                            <span>{{ material.label }}</span>
                            <span class="filter-count">({{ material.count }})</span>
                        </label>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>

        <div class="filter-group expanded">
            <div class="filter-group-title" onclick="toggleFilterGroup(this)">
                <span>年代篩選</span>
                <span class="filter-group-toggle">−</span>
            </div>
            <div class="filter-group-content">
                <div style="font-size: 0.85rem; font-weight: bold; color: #8b4513; margin: 5px 0;">東方 (中國)</div>
                <ul class="filter-checkbox-list">
                    <li class="filter-checkbox-item">
                        <input type="checkbox" name="era_range" value="960|1279" onchange="applyEraRange(this)">
                        <label>宋代</label>
                    </li>
                    <li class="filter-checkbox-item">
                        <input type="checkbox" name="era_range" value="1368|1644" onchange="applyEraRange(this)">
                        <label>明代</label>
                    </li>
                    <li class="filter-checkbox-item">
                        <input type="checkbox" name="era_range" value="1644|1911" onchange="applyEraRange(this)">
                        <label>清代</label>
                    </li>
                </ul>
                <div style="font-size: 0.85rem; font-weight: bold; color: #2f4f4f; border-top: 1px solid #eee; padding-top: 10px; margin: 10px 0 5px 0;">西方</div>
            <ul class="filter-checkbox-list">
                <li class="filter-checkbox-item">
                    <input type="checkbox" name="era_range" value="-3000|500" onchange="applyEraRange(this)">
                    <label>古代 (-3000至500)</label>
                </li>
                <li class="filter-checkbox-item">
                    <input type="checkbox" name="era_range" value="501|1450" onchange="applyEraRange(this)">
                    <label>中世紀 (501-1450)</label>
                </li>
                <li class="filter-checkbox-item">
                    <input type="checkbox" name="era_range" value="1451|1800" onchange="applyEraRange(this)">
                    <label>近世 (1451-1800)</label>
                </li>
                <li class="filter-checkbox-item">
                    <input type="checkbox" name="era_range" value="1801|2025" onchange="applyEraRange(this)">
                    <label>近代/現代 (1801-至今)</label>
                </li>
            </ul>
                <div class="custom-era-input">
                    <div style="font-size: 0.8rem; margin-bottom: 8px; color: #666;">自定義年份 (西元)</div>
                    <div style="display: flex; gap: 5px; align-items: center;">
                        <input type="number" id="start-year-input" placeholder="始" style="width: 70px; padding: 4px;">
                        <span>-</span>
                        <input type="number" id="end-year-input" placeholder="末" style="width: 70px; padding: 4px;">
                        <button type="button" onclick="applyCustomEra()" style="background: var(--color-primary); color: white; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer;">Go</button>
                    </div>
                </div>
            </div>
        </div>
    </aside>

    <main class="search-main">
        <div class="search-header">
            <h2 class="search-title">搜索 "{{ search_term }}" 的结果</h2>
            <p class="search-result-count">(共找到 {{ artifacts|length }} 件文物)</p>
        </div>

        <div class="sort-bar">
            <span class="sort-label">排序方式:</span>
            <select id="sortSelect" onchange="applySort(this.value)" style="padding: 5px; border-radius: 4px;">
                <option value="relevance" {% if sort_by == 'relevance' %}selected{% endif %}>相关度</option>
                <option value="era_asc" {% if sort_by == 'era_asc' %}selected{% endif %}>年代從早到晚</option>
                <option value="era_desc" {% if sort_by == 'era_desc' %}selected{% endif %}>年代從晚到早</option>
            </select>
        </div>

        {% if artifacts %}
        <div class="search-results-grid">
            {% for item in artifacts %}
            <a href="{{ url_for('detail', artifact_id=item.artifact_id) }}" class="card">
                <div class="card-image-wrapper">
                    {% if item.local_path %}
                        <img src="{{ url_for('static', filename=item.local_path) }}" class="card-image">
                    {% else %}
                        <div style="height:100%; display:flex; align-items:center; justify-content:center; background:#eee; color:#999;">暫無圖片</div>
                    {% endif %}
                </div>
                <div class="card-info">
                    <div class="card-title">{{ item.title or '未命名' }}</div>
                    <div class="card-date">{{ item.date_text or '年代未知' }}</div>
                    {% if item.culture_name %}
                        <div style="font-size: 0.8rem; color: #666; margin-top: 5px;">{{ item.culture_name }}</div>
                    {% endif %}
                </div>
            </a>
            {% endfor %}
        </div>
        {% else %}
        <div class="no-results">
            <p class="no-results-title">未找到相關結果</p>
            <a href="{{ url_for('homepage') }}" style="color: var(--color-primary); text-decoration: none;">返回首頁</a>
        </div>
        {% endif %}
    </main>
</div>

<script>
    function toggleFilterGroup(element) {
        const group = element.closest('.filter-group');
        const isExpanded = group.classList.toggle('expanded');
        group.classList.toggle('collapsed');
        element.querySelector('.filter-group-toggle').textContent = isExpanded ? '−' : '+';
    }

    function applyFilter(filterType, filterValue, isChecked) {
        const url = new URL(window.location.href);
        let currentValues = url.searchParams.getAll(filterType);
        
        if (isChecked) {
            if (!currentValues.includes(filterValue)) url.searchParams.append(filterType, filterValue);
        } else {
            url.searchParams.delete(filterType);
            currentValues.filter(v => v !== filterValue).forEach(v => url.searchParams.append(filterType, v));
        }
        window.location.href = url.toString();
    }

    function removeFilter(filterType, filterValue) {
        applyFilter(filterType, filterValue, false);
    }

    /**
 * 修正後的年代勾選邏輯：確保單選，避免分類衝突
 */
function applyEraRange(checkbox) {
    const url = new URL(window.location.href);
    
    // 1. 如果選中，取消其他所有 era_range 的勾選
    if (checkbox.checked) {
        document.querySelectorAll('input[name="era_range"]').forEach(cb => {
            if (cb !== checkbox) cb.checked = false;
        });
        
        const [start, end] = checkbox.value.split('|');
        url.searchParams.set('start_year', start);
        url.searchParams.set('end_year', end);
    } else {
        // 2. 如果取消勾選，移除參數
        url.searchParams.delete('start_year');
        url.searchParams.delete('end_year');
    }
    
    window.location.href = url.toString();
}

    function applyCustomEra() {
        const start = document.getElementById('start-year-input').value;
        const end = document.getElementById('end-year-input').value;
        const url = new URL(window.location.href);
        if (start) url.searchParams.set('start_year', start);
        if (end) url.searchParams.set('end_year', end);
        window.location.href = url.toString();
    }

    function clearEra() {
        const url = new URL(window.location.href);
        url.searchParams.delete('start_year');
        url.searchParams.delete('end_year');
        window.location.href = url.toString();
    }

    function clearAllFilters() {
        const url = new URL(window.location.href);
        const q = url.searchParams.get('q');
        window.location.href = window.location.pathname + (q ? '?q=' + q : '');
    }

    function applySort(val) {
        const url = new URL(window.location.href);
        url.searchParams.set('sort', val);
        window.location.href = url.toString();
    }
</script>
{% endblock %}
